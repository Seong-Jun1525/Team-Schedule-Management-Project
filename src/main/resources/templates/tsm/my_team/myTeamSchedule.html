<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Team Schedule</title>
    
    <!-- 스타일 -->
    <link rel="stylesheet" href="../../assets/css/index.css" />
    <link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="../../assets/css/my-team-schedule.css" />

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <div class="container">
        <div class="team-schedule-wrapper">
            <div class="team-schedule-container">
                <div class="team-schedule-header">
                    <p class="team-schedule-title">
                        <i class="fa-solid fa-calendar-days"></i><span th:text="${teamInfo.teamName} + ' 팀의 일정'"></span>
                    </p>
                </div>
                <div class="team-schedule-content">
                    <!-- 캘린더를 렌더링할 div -->
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- footer -->
    <footer>
        <div th:replace="~{fragment/footer :: footerFragment}"></div>
    </footer>

    <!-- FullCalendar 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const teamNum = [[${teamNum}]]; // Thymeleaf에서 팀 번호 전달
            if (calendarEl) {
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    selectable: true,
                    navLinks: true,
                    editable: true,
                    nowIndicator: true,
                    dayMaxEvents: true,
                    locale: 'ko',
                    customButtons: {
                        testButton: {
                            text: '테스트 버튼'
                        }
                    },
                    eventAdd: function (obj) {
                        console.log("Event added:", obj);
                    },
                    eventChange: function (obj) {
                        console.log("Event changed:", obj);
                    },
                    eventRemove: function (obj) {
                        console.log("Event removed:", obj);
                    },
                    select: function (arg) {
					    const title = prompt('일정 이름을 입력해주세요');
					    const state = prompt('일정 유형 (예: REGULAR_MEETING, ADDITIONAL_MEETING, VACATION, ETC)');
					    if (title && state) {
					        const newEvent = {
					            teamNum: teamNum,
					            teamScheduleContent: title,
					            teamScheduleStartDate: arg.start.toISOString(),
					            teamScheduleEndDate: arg.end ? arg.end.toISOString() : null,
					            allDay: arg.allDay,
					            scheduleState: state
					        };
					
					        fetch('/my-team/schedule/insertCalendar', {
					            method: 'POST',
					            headers: { 'Content-Type': 'application/json' },
					            body: JSON.stringify(newEvent)
					        })
					        .then(response => {
					            if (!response.ok) throw new Error('Error saving event');
					            return response.json();
					        })
					        .then(data => {
					            calendar.addEvent({
					                id: data.teamScheduleId,
					                title: data.teamScheduleContent,
					                start: data.teamScheduleStartDate,
					                end: data.teamScheduleEndDate,
					                allDay: data.allDay
					            });
					        })
					        .catch(error => {
					            console.error('Error:', error);
					            alert('일정을 저장하는 중 오류가 발생했습니다.');
					        });
					    }
					    calendar.unselect();
					},
                    events: function (fetchInfo, successCallback, failureCallback) {
					    fetch(`/my-team/schedule/events?teamNum=${teamNum}`) // 새 엔드포인트 호출
					        .then(response => {
					            if (!response.ok) {
					                throw new Error('Failed to fetch events');
					            }
					            return response.json();
					        })
					        .then(data => {
					            // 서버에서 반환된 데이터를 FullCalendar 이벤트 형식으로 변환
					            const events = data.map(event => ({
					                id: event.id,
					                title: event.title,
					                start: event.start,
					                end: event.end,
					                allDay: event.allDay
					            }));
					            console.log('Fetched events:', events);
					            successCallback(events);
					        })
					        .catch(error => {
					            console.error('Error fetching events:', error);
					            failureCallback(error);
					        });
					}
                });
                calendar.render();
            } else {
                console.error('캘린더 요소를 찾을 수 없습니다.');
            }
        });
    </script>
</body>
</html>