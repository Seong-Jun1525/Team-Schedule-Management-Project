<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Team Schedule</title>
    
    <!-- 스타일 -->
	<link rel="stylesheet" href="../../assets/css/index.css" />
	<link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="../../assets/css/my-team-schedule.css" />

    <!-- FullCalendar 스타일 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
	<div class="container">
		<div class="team-schedule-wrapper">
	        <div class="team-schedule-container">
	            <div class="team-schedule-header">
	                <p class="team-schedule-title">
	                    <i class="fa-solid fa-calendar-days"></i><span th:text="${myTeamInfo.teamName} + ' 팀의 일정'"></span>
	                </p>
	            </div>
	            <div class="team-schedule-content">
	                <!-- 캘린더를 렌더링할 div -->
	                <div id="calendar"></div>
	            </div>
	        </div>
	    </div>
	</div>
	
	<!-- footer -->
	<footer>
        <div th:replace="~{fragment/footer :: footerFragment}"></div>
	</footer>

    <!-- FullCalendar 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <script>
        // DOMContentLoaded 이벤트를 사용해 FullCalendar 초기화
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                // FullCalendar 초기화
                var calendar = new FullCalendar.Calendar(calendarEl, {
					initialView: 'dayGridMonth', // 기본 보기
					slotMinTime: '00:00', // Day 캘린더에서 시작 시간
    				slotMaxTime: '23:59', // Day 캘린더에서 종료 시간
    				customButtons: { // 사용자가 만드는 버튼
			            testButton: {
			                text: "테스트버튼"
			            }
			        },
					selectable: true, // 날짜 선택
					unselectAuto: true, // selectable이 true일 경우만 설정 가능. 기본값 true
					navLinks: true,                 // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
			        editable: true,                 // default : false 이벤트 드래그 등의 편집여부를 설정함
			        selectable: true,               // 일자 드래그 설정
			        nowIndicator: true,             // 현재 시간 마크
			        dayMaxEvents: true,             // 이벤트가 많아지면 + 로 이벤트 표시
			        locale: 'ko',                   // 한국어 설정
			        eventAdd: function (obj) {      // 이벤트 추가 시 발생
			            console.log("eventAdd : " + obj);
			        },
			        eventChange: function (obj) {    // 이벤트 수정 시 발생
			            console.log("eventChange : " + obj);
			        },
			        eventRemove: function (obj) {     // 이벤트 삭제 시 발생
			            console.log("eventRemove : " + obj);
			        },
			        select: function (arg) {
					    let title = prompt('일정 입력');
					    if (title) {
					        let newData = {
					            title: title,
					            start: arg.start,
					            end: arg.end,
					            allDay: arg.allDay
					        };
					        fetch('/calendarSave', {
					            method: 'POST',
					            headers: {
					                'Content-Type': 'application/json'
					            },
					            body: JSON.stringify(newData)
					        })
					        .then(response => response.json())
					        .then(data => {
					            if (data) {
					                calendar.addEvent({
					                    id: data.calendarNo,
					                    title: data.title,
					                    start: data.start1,
					                    end: data.end,
					                    allDay: data.allDay,
					                    editable: true
					                });
					            }
					        })
					        .catch(error => console.error('Error saving event:', error));
					    }
					    calendar.unselect();
					},
					
					eventClick: function (arg) {
					    if (confirm("선택한 일정을 삭제하시겠습니까?")) {
					        fetch('/calendarDelete', {
					            method: 'DELETE',
					            headers: {
					                'Content-Type': 'application/json'
					            },
					            body: JSON.stringify({ no: arg.event.id })
					        })
					        .then(response => response.text())
					        .then(data => {
					            if (data === 'success') {
					                alert("삭제하였습니다.");
					                arg.event.remove();
					            } else {
					                alert("오류가 발생하였습니다");
					            }
					        })
					        .catch(error => console.error('Error deleting event:', error));
					    }
					},
					
					eventDrop: function (arg) {
					    let event = {
					        id: arg.event.id,
					        title: arg.event.title,
					        start1: arg.event._instance.range.start,
					        end: arg.event._instance.range.end ? arg.event._instance.range.end : null,
					        allDay: arg.event.allDay
					    };
					    fetch(`/eventUpdate/${arg.event.id}`, {
					        method: 'PUT',
					        headers: {
					            'Content-Type': 'application/json'
					        },
					        body: JSON.stringify(event)
					    })
					    .catch(error => console.error('Error updating event:', error));
					},
					
					eventResize: function (arg) {
					    let event = {
					        id: arg.event.id,
					        title: arg.event.title,
					        start1: arg.event._instance.range.start,
					        end: arg.event._instance.range.end ? arg.event._instance.range.end : null,
					        allDay: arg.event.allDay
					    };
					    fetch(`/eventUpdate/${arg.event.id}`, {
					        method: 'PUT',
					        headers: {
					            'Content-Type': 'application/json'
					        },
					        body: JSON.stringify(event)
					    })
					    .catch(error => console.error('Error updating event:', error));
					},
					
					events: function (fetchInfo, successCallback, failureCallback) {
					    fetch('/calendarList', {
					        method: 'GET'
					    })
					    .then(response => response.json())
					    .then(data => {
					        let events = data.map(event => ({
					            id: event.calendarNo,
					            title: event.title,
					            start: event.start1,
					            end: event.end,
					            allDay: event.allDay,
					            editable: true
					        }));
					        successCallback(events);
					    })
					    .catch(error => {
					        console.error('Error fetching events:', error);
					        failureCallback(error);
					    });
					}
                });
                calendar.render(); // 캘린더 렌더링
            } else {
                console.error('Calendar element not found!');
            }
        });
    </script>
</body>
</html>